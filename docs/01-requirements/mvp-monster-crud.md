# 🎮 MVP要件定義書 - モンスターCRUD機能

**作成日**: 2025年7月6日  
**バージョン**: v1.0  
**ステータス**: ドラフト

## 📋 概要

このドキュメントは、モンスター収集型ゲーム学習プロジェクトの最初のリリース（MVP）を「所持モンスターのCRUD操作」に特化して定義します。プレイヤーがモンスターを獲得し、管理する基本的な体験を提供することで、データベース操作の基礎を学習できます。

## 🎯 MVP目標

### 学習目標
1. **CRUD操作の理解** - Create, Read, Update, Delete の基本概念を実践
2. **フロントエンド・バックエンド連携** - APIを通じたデータのやり取り
3. **データベース設計の基礎** - リレーショナルデータベースの基本

### 達成指標
- プレイヤーがモンスターを獲得できる
- 獲得したモンスターの一覧を確認できる
- モンスターにニックネームを付けられる
- モンスターを逃がすことができる

## 🔧 技術スコープ

### フロントエンド
- **React + TypeScript** によるSPA
- **Grid Layout** によるレスポンシブUI
- **fetch API** によるバックエンド通信
- **useState/useEffect** による状態管理
- **Tailwind + Shadcn**によるコンポーネントスタイリング

### バックエンド
- **Hono** によるREST API実装
- **Zod** による入力値バリデーション
- **エラーハンドリング** の実装
- **CORS設定** の適切な実装

### データベース
- **Cloudflare D1** (SQLite)
- **Drizzle ORM** による型安全なクエリ
- **マイグレーション** の実装
- **トランザクション** の基本的な使用

## 📱 MVP機能要件

### 1. プレイヤー作成機能
- **シンプルな登録**
  - プレイヤー名の入力（3-20文字）
  - 自動的にIDを生成
  - 初期モンスター1体を自動付与

### 2. モンスター獲得機能（Create）
- **簡易バトルシステム**
  - ランダムに出現するモンスター（3種類程度）
  - 「たたかう」でHPを減らす（固定ダメージ）
  - HPが半分以下で捕獲可能
  - 捕獲成功率は固定（50%）
- **獲得時の処理**
  - プレイヤーの所持モンスターに追加
  - デフォルト名（種族名）で保存
  - 獲得日時を記録

### 3. モンスター一覧機能（Read）
- **所持モンスター表示**
  - カード形式でグリッド表示
  - モンスター名（ニックネーム）
  - 種族名
  - 現在のHP/最大HP
  - 獲得日時
- **ソート・フィルタ機能**
  - 獲得日時順（新しい順/古い順）
  - 種族別フィルタ

### 4. ニックネーム変更機能（Update）
- **編集モード**
  - モンスターカードをクリックで編集モード
  - インライン編集でニックネーム変更
  - 文字数制限（1-20文字）
  - 保存/キャンセルボタン

### 5. モンスター解放機能（Delete）
- **解放確認**
  - 「逃がす」ボタンでモーダル表示
  - 確認メッセージ表示
  - 「本当に逃がす」で削除実行
- **削除後の処理**
  - 一覧から即座に削除
  - 成功メッセージ表示

## 📊 データ設計

### テーブル構造

#### 1. players（プレイヤー）
```sql
CREATE TABLE players (
  id TEXT PRIMARY KEY,
  name TEXT NOT NULL,
  created_at TEXT DEFAULT CURRENT_TIMESTAMP
);
```

#### 2. monster_species（モンスター種族マスタ）
```sql
CREATE TABLE monster_species (
  id TEXT PRIMARY KEY,
  name TEXT NOT NULL,        -- 種族名（例：でんきネズミ）
  base_hp INTEGER NOT NULL,  -- 基本HP
  rarity TEXT NOT NULL       -- レア度（common/rare/epic）
);
```

#### 3. owned_monsters（所持モンスター）
```sql
CREATE TABLE owned_monsters (
  id TEXT PRIMARY KEY,
  player_id TEXT NOT NULL,
  species_id TEXT NOT NULL,
  nickname TEXT,              -- ニックネーム（NULL可）
  current_hp INTEGER NOT NULL,
  max_hp INTEGER NOT NULL,
  captured_at TEXT DEFAULT CURRENT_TIMESTAMP,
  FOREIGN KEY (player_id) REFERENCES players(id),
  FOREIGN KEY (species_id) REFERENCES monster_species(id)
);
```

### 初期データ

```sql
-- モンスター種族マスタデータ
INSERT INTO monster_species (id, name, base_hp, rarity) VALUES
  ('1', 'でんきネズミ', 35, 'common'),
  ('2', 'ほのおトカゲ', 40, 'common'),
  ('3', 'みずガメ', 45, 'rare');
```

## 🔌 API設計

### エンドポイント一覧

#### 1. プレイヤー管理
- **POST /api/players** - プレイヤー作成
  ```json
  Request: { "name": "プレイヤー名" }
  Response: { "id": "xxx", "name": "プレイヤー名", "initialMonsterId": "yyy" }
  ```

#### 2. モンスター獲得
- **POST /api/players/:playerId/monsters** - モンスター獲得
  ```json
  Request: { "speciesId": "1" }
  Response: { "id": "xxx", "nickname": "でんきネズミ", "speciesName": "でんきネズミ" }
  ```

#### 3. モンスター一覧
- **GET /api/players/:playerId/monsters** - 所持モンスター一覧
  ```json
  Response: {
    "monsters": [
      {
        "id": "xxx",
        "nickname": "ピカ",
        "speciesName": "でんきネズミ",
        "currentHp": 30,
        "maxHp": 35,
        "capturedAt": "2025-07-06T10:00:00Z"
      }
    ]
  }
  ```

#### 4. ニックネーム変更
- **PUT /api/monsters/:monsterId** - モンスター情報更新
  ```json
  Request: { "nickname": "新しいニックネーム" }
  Response: { "id": "xxx", "nickname": "新しいニックネーム" }
  ```

#### 5. モンスター解放
- **DELETE /api/monsters/:monsterId** - モンスター削除
  ```json
  Response: { "message": "モンスターを逃がしました" }
  ```

## 🎨 UI設計

### 画面構成

#### 1. スタート画面
```
┌─────────────────────────────────┐
│    モンスター収集ゲーム         │
│                                 │
│   プレイヤー名: [_______]       │
│                                 │
│      [ゲーム開始]               │
└─────────────────────────────────┘
```

#### 2. メイン画面（モンスター一覧）
```
┌─────────────────────────────────┐
│ プレイヤー: 太郎  [バトル開始]  │
├─────────────────────────────────┤
│ 所持モンスター (3体)            │
│                                 │
│ ┌─────┐ ┌─────┐ ┌─────┐     │
│ │でんき│ │ほのお│ │みず  │     │
│ │ネズミ│ │トカゲ│ │ガメ  │     │
│ │ ピカ │ │ヒト  │ │カメ  │     │
│ │30/35 │ │40/40 │ │45/45 │     │
│ └─────┘ └─────┘ └─────┘     │
└─────────────────────────────────┘
```

#### 3. バトル画面
```
┌─────────────────────────────────┐
│        野生のモンスター         │
│         でんきネズミ            │
│          HP: 20/35              │
│                                 │
│   [たたかう]  [つかまえる]      │
│             [にげる]            │
│                                 │
│ メッセージ: ____________        │
└─────────────────────────────────┘
```

#### 4. 編集モーダル
```
┌─────────────────────────────────┐
│     ニックネームを変更          │
│                                 │
│  現在: でんきネズミ             │
│  新規: [____________]           │
│                                 │
│   [保存]    [キャンセル]        │
└─────────────────────────────────┘
```

## 📝 実装計画

### Week 1: 基盤構築
- [x] プロジェクトセットアップ（CIパイプライン構築）
- [x] データベーススキーマ作成
- [x] 基本的なAPI実装（プレイヤー作成）
- [x] フロントエンドルーティング設定

### Week 2: CRUD実装
- [x] モンスター獲得API（Create）
- [x] モンスター一覧API（Read）
- [x] ニックネーム変更API（Update）
- [x] モンスター解放API（Delete）

### Week 3: リファクタリング
現在変数名、関数名、ファイル名に日本語が使われているが、データベースとの接続や文字化けする観点から英語に変換する。
ただし、プログラミング初学者が英語でつまずいてほしくないので、JSDocで日本語で補足する
- [x] 変数、関数にJSDocをつける（後に英語にするが、元の名前を残すため）
- [x] 変数名、関数名を英語にする
- [x] ファイル名を英語にする

### Week 4: UI実装
- [ ] スタート画面
- [ ] プレイヤー作成画面
- [ ] マップ画面
- [ ] モンスター一覧画面
- [ ] バトル画面
- [ ] 編集・削除機能のUI

### Week 5: 統合・デプロイ
- [ ] フロントエンド・バックエンド統合
- [ ] エラーハンドリング強化
- [ ] Cloudflareへのデプロイ
- [ ] 動作確認・バグ修正

## 🚀 段階的拡張案

### Phase 1（MVP後すぐ）
- マップ移動
- ランダムエンカウント
- 複数のモンスター種類追加

### Phase 2（1ヶ月後）
- モンスターのレベル概念
- 経験値システム
- 複数の技

### Phase 3（2ヶ月後）
- モンスター進化
- タイプ相性
- トレーナーバトル
- アイテムシステム

## 💡 初学者向けの工夫

### コード設計
- **明確な責務分離** - 1ファイル1機能
- **日本語コメント** - 各処理の意図を説明
- **エラーメッセージ** - 分かりやすい日本語表記

### 学習ステップ
1. **データベース基礎** - CRUD操作の理解
2. **API設計** - RESTfulな設計の実践
3. **状態管理** - Reactでのデータ管理
4. **非同期処理** - Promise/async-awaitの使用

## 📌 注意事項

### セキュリティ考慮
- SQLインジェクション対策（パラメータ化クエリ）
- 入力値バリデーション（Zod使用）
- CORS設定の適切な実装

### パフォーマンス考慮
- N+1問題の回避（JOIN使用）
- 適切なインデックス設定
- ページネーション（将来実装）

### 保守性考慮
- TypeScriptの厳格な型定義
- テストコードの作成（TDD）
- ドキュメントの継続的更新